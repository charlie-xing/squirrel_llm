<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent & MCP API æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f7;
        }
        h1 {
            color: #1d1d1f;
            border-bottom: 2px solid #0071e3;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #0071e3;
            margin-top: 0;
        }
        button {
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0077ED;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f9f9f9;
            border-left: 4px solid #0071e3;
            padding: 16px;
            margin: 16px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left-color: #34c759; }
        .error { border-left-color: #ff3b30; }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.ok { background: #d1f2eb; color: #0a5f38; }
        .status.fail { background: #fadbd8; color: #7a2520; }
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Agent & MCP API æµ‹è¯•å·¥å…·</h1>

    <div class="info-box">
        <strong>âš ï¸ å¼€å‘æ¨¡å¼</strong><br>
        å½“å‰ä½¿ç”¨ Mock API è¿›è¡Œæµ‹è¯•ã€‚æ‰€æœ‰è°ƒç”¨è¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼Œç”¨äºéªŒè¯ API è®¾è®¡å’Œæ¥å£å®Œæ•´æ€§ã€‚
    </div>

    <!-- Agent API æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ¤– Agent API æµ‹è¯•</h2>

        <h3>1. æ³¨å†Œ Agent</h3>
        <button onclick="testRegisterAgent()">æ³¨å†Œæµ‹è¯• Agent</button>
        <div id="register-result" class="result" style="display:none;"></div>

        <h3>2. åˆ—å‡º Agents</h3>
        <button onclick="testListAgents()">è·å– Agent åˆ—è¡¨</button>
        <div id="list-result" class="result" style="display:none;"></div>

        <h3>3. è°ƒç”¨ Agent (æ™®é€š)</h3>
        <button onclick="testInvokeAgent()">è°ƒç”¨ Agent</button>
        <div id="invoke-result" class="result" style="display:none;"></div>

        <h3>4. æµå¼è°ƒç”¨ Agent</h3>
        <button onclick="testStreamAgent()" id="stream-btn">å¼€å§‹æµå¼è°ƒç”¨</button>
        <div id="stream-result" class="result" style="display:none;"></div>
    </div>

    <!-- MCP API æµ‹è¯• -->
    <div class="test-section">
        <h2>ğŸ”Œ MCP API æµ‹è¯•</h2>

        <h3>1. è·å– MCP ä¸Šä¸‹æ–‡</h3>
        <button onclick="testGetContext()">è·å–ä¸Šä¸‹æ–‡</button>
        <div id="context-result" class="result" style="display:none;"></div>

        <h3>2. åˆ—å‡º MCP å·¥å…·</h3>
        <button onclick="testListTools()">åˆ—å‡ºå·¥å…·</button>
        <div id="tools-result" class="result" style="display:none;"></div>

        <h3>3. ä½¿ç”¨ MCP å·¥å…·</h3>
        <button onclick="testUseTool()">è°ƒç”¨å·¥å…·</button>
        <div id="use-tool-result" class="result" style="display:none;"></div>

        <h3>4. è·å– MCP èµ„æº</h3>
        <button onclick="testGetResource()">è·å–èµ„æº</button>
        <div id="resource-result" class="result" style="display:none;"></div>

        <h3>5. è·å–æç¤ºè¯</h3>
        <button onclick="testGetPrompt()">è·å–æç¤ºè¯</button>
        <div id="prompt-result" class="result" style="display:none;"></div>
    </div>

    <!-- æ€§èƒ½æµ‹è¯• -->
    <div class="test-section">
        <h2>âš¡ æ€§èƒ½ç›‘æ§æµ‹è¯•</h2>
        <button onclick="testPerformance()">æµ‹è¯•æ€§èƒ½ç›‘æ§</button>
        <div id="perf-result" class="result" style="display:none;"></div>
    </div>

    <!-- å¼•å…¥ Bridge SDK -->
    <script src="sdk_v2/squirrel-bridge.js"></script>

    <script>
        // å¼ºåˆ¶å¯ç”¨å¼€å‘æ¨¡å¼ï¼ˆåœ¨ SDK åŠ è½½å‰è®¾ç½®ï¼‰
        // è¿™æ ·å¯ä»¥é¿å…å°è¯•è°ƒç”¨çœŸå®çš„ webkit.messageHandlers
        if (!window.webkit || !window.webkit.messageHandlers) {
            console.log('[Test] Running in browser mode - enabling Mock API');
            // SDK ä¼šæ£€æµ‹åˆ°æ²¡æœ‰ webkit å¹¶è‡ªåŠ¨ä½¿ç”¨ Mock
        }

        // ç­‰å¾… SDK åŠ è½½å®Œæˆ
        if (window.SquirrelBridge) {
            window.SquirrelBridge.isDevelopment = true;
            console.log('[Test] Mock API enabled');
        } else {
            console.error('[Test] SquirrelBridge not loaded!');
        }

        // è¾…åŠ©å‡½æ•°
        function showResult(id, content, isError = false) {
            const el = document.getElementById(id);
            el.textContent = content;
            el.className = isError ? 'result error' : 'result success';
            el.style.display = 'block';
        }

        // ========== Agent æµ‹è¯• ==========

        async function testRegisterAgent() {
            try {
                console.log('[Test] Registering agent...');
                await SquirrelBridge.Agent.registerAgent({
                    id: 'test-agent-1',
                    name: 'æµ‹è¯• Agent',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨çš„ Agent',
                    endpoint: 'http://localhost:8000/agent',
                    auth: {
                        type: 'bearer',
                        token: 'test-token-12345'
                    },
                    capabilities: ['chat', 'analyze', 'summarize'],
                    timeout: 30000
                });

                showResult('register-result',
                    'âœ… Agent æ³¨å†ŒæˆåŠŸ!\n\n' +
                    'Agent ID: test-agent-1\n' +
                    'Name: æµ‹è¯• Agent\n' +
                    'Endpoint: http://localhost:8000/agent\n' +
                    'Auth Type: bearer\n' +
                    'Capabilities: chat, analyze, summarize'
                );
            } catch (error) {
                showResult('register-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testListAgents() {
            try {
                console.log('[Test] Listing agents...');
                const agents = await SquirrelBridge.Agent.listAgents();

                let result = `âœ… æ‰¾åˆ° ${agents.length} ä¸ª Agent:\n\n`;
                agents.forEach((agent, i) => {
                    result += `${i + 1}. ${agent.name} (${agent.id})\n`;
                    result += `   Endpoint: ${agent.endpoint}\n`;
                    result += `   Capabilities: ${agent.capabilities?.join(', ') || 'N/A'}\n\n`;
                });

                showResult('list-result', result);
            } catch (error) {
                showResult('list-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testInvokeAgent() {
            try {
                console.log('[Test] Invoking agent...');

                SquirrelBridge.Performance.mark('invoke.start');

                const response = await SquirrelBridge.Agent.invoke({
                    agent: 'test-agent-1',
                    action: 'analyze',
                    params: {
                        text: 'è¿™æ˜¯ä¸€æ®µéœ€è¦åˆ†æçš„æµ‹è¯•æ–‡æœ¬',
                        options: { detailed: true }
                    }
                });

                SquirrelBridge.Performance.mark('invoke.end');
                const perf = SquirrelBridge.Performance.measure(
                    'Agent Invoke',
                    'invoke.start',
                    'invoke.end'
                );

                let result = `âœ… Agent è°ƒç”¨æˆåŠŸ!\n\n`;
                result += `Success: ${response.success}\n`;
                result += `Data: ${JSON.stringify(response.data, null, 2)}\n`;
                result += `Metadata: ${JSON.stringify(response.metadata, null, 2)}\n\n`;
                result += `â±ï¸ æ€§èƒ½: ${perf.duration.toFixed(2)}ms`;

                showResult('invoke-result', result);
            } catch (error) {
                showResult('invoke-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testStreamAgent() {
            const btn = document.getElementById('stream-btn');
            btn.disabled = true;

            try {
                console.log('[Test] Stream invoking agent...');

                let result = 'ğŸ”„ å¼€å§‹æµå¼è°ƒç”¨...\n\n';
                showResult('stream-result', result);

                let chunkCount = 0;

                await SquirrelBridge.Agent.streamInvoke({
                    agent: 'test-agent-1',
                    action: 'generate',
                    params: {
                        prompt: 'ç”Ÿæˆä¸€æ®µå…³äº AI çš„æ–‡æœ¬'
                    },
                    onChunk: (chunk) => {
                        chunkCount++;
                        result += `Chunk ${chunkCount}: ${chunk}\n`;
                        showResult('stream-result', result);
                    },
                    onComplete: (finalData) => {
                        result += `\nâœ… æµå¼è°ƒç”¨å®Œæˆ!\n`;
                        result += `æ€»å…±æ”¶åˆ° ${chunkCount} ä¸ªæ•°æ®å—\n`;
                        result += `Final data: ${JSON.stringify(finalData, null, 2)}`;
                        showResult('stream-result', result);
                        btn.disabled = false;
                    },
                    onError: (error) => {
                        result += `\nâŒ é”™è¯¯: ${error}`;
                        showResult('stream-result', result, true);
                        btn.disabled = false;
                    }
                });
            } catch (error) {
                showResult('stream-result', `âŒ é”™è¯¯: ${error.message}`, true);
                btn.disabled = false;
            }
        }

        // ========== MCP æµ‹è¯• ==========

        async function testGetContext() {
            try {
                console.log('[Test] Getting MCP context...');
                const context = await SquirrelBridge.MCP.getContext();

                let result = 'âœ… MCP ä¸Šä¸‹æ–‡è·å–æˆåŠŸ!\n\n';
                result += `Resources: ${context.resources.length}\n`;
                result += `Tools: ${context.tools.length}\n`;
                result += `Prompts: ${context.prompts.length}\n\n`;
                result += `Server Info:\n`;
                result += `  Name: ${context.serverInfo.name}\n`;
                result += `  Version: ${context.serverInfo.version}\n`;
                result += `  Protocol: ${context.serverInfo.protocolVersion}\n`;

                showResult('context-result', result);
            } catch (error) {
                showResult('context-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testListTools() {
            try {
                console.log('[Test] Listing MCP tools...');
                const tools = await SquirrelBridge.MCP.listTools();

                let result = `âœ… æ‰¾åˆ° ${tools.length} ä¸ªå·¥å…·:\n\n`;
                tools.forEach((tool, i) => {
                    result += `${i + 1}. ${tool.name}\n`;
                    result += `   Description: ${tool.description}\n`;
                    result += `   Schema: ${JSON.stringify(tool.inputSchema, null, 2)}\n\n`;
                });

                showResult('tools-result', result);
            } catch (error) {
                showResult('tools-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testUseTool() {
            try {
                console.log('[Test] Using MCP tool...');

                SquirrelBridge.Performance.mark('tool.start');

                const result = await SquirrelBridge.MCP.useTool('mock_tool', {
                    query: 'æµ‹è¯•æŸ¥è¯¢'
                });

                SquirrelBridge.Performance.mark('tool.end');
                const perf = SquirrelBridge.Performance.measure(
                    'MCP Tool',
                    'tool.start',
                    'tool.end'
                );

                let output = `âœ… å·¥å…·è°ƒç”¨æˆåŠŸ!\n\n`;
                output += `Success: ${result.success}\n`;
                output += `Content:\n`;
                result.content.forEach((item, i) => {
                    output += `  ${i + 1}. Type: ${item.type}\n`;
                    output += `     Text: ${item.text}\n`;
                });
                output += `\nâ±ï¸ æ€§èƒ½: ${perf.duration.toFixed(2)}ms`;

                showResult('use-tool-result', output);
            } catch (error) {
                showResult('use-tool-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testGetResource() {
            try {
                console.log('[Test] Getting MCP resource...');
                const content = await SquirrelBridge.MCP.getResource('file:///mock/document.txt');

                let result = 'âœ… èµ„æºè·å–æˆåŠŸ!\n\n';
                result += `URI: ${content.uri}\n`;
                result += `MIME Type: ${content.mimeType}\n`;
                result += `Content:\n${content.text}`;

                showResult('resource-result', result);
            } catch (error) {
                showResult('resource-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        async function testGetPrompt() {
            try {
                console.log('[Test] Getting MCP prompt...');
                const prompt = await SquirrelBridge.MCP.getPrompt('mock_prompt', {
                    topic: 'AI æŠ€æœ¯'
                });

                let result = 'âœ… æç¤ºè¯è·å–æˆåŠŸ!\n\n';
                result += `Description: ${prompt.description}\n\n`;
                result += `Messages:\n`;
                prompt.messages.forEach((msg, i) => {
                    result += `${i + 1}. Role: ${msg.role}\n`;
                    result += `   Content: ${msg.content.text}\n\n`;
                });

                showResult('prompt-result', result);
            } catch (error) {
                showResult('prompt-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        // ========== æ€§èƒ½æµ‹è¯• ==========

        async function testPerformance() {
            try {
                console.log('[Test] Testing performance monitoring...');

                // æ‰§è¡Œå¤šä¸ªæ“ä½œæµ‹è¯•æ€§èƒ½
                SquirrelBridge.Performance.mark('test.start');

                await SquirrelBridge.Agent.listAgents();
                SquirrelBridge.Performance.mark('agents.done');

                await SquirrelBridge.MCP.listTools();
                SquirrelBridge.Performance.mark('tools.done');

                await SquirrelBridge.MCP.getContext();
                SquirrelBridge.Performance.mark('test.end');

                const total = SquirrelBridge.Performance.measure(
                    'Total Test',
                    'test.start',
                    'test.end'
                );

                const entries = SquirrelBridge.Performance.getEntries();

                let result = 'âœ… æ€§èƒ½ç›‘æ§æµ‹è¯•å®Œæˆ!\n\n';
                result += `æ€»è€—æ—¶: ${total.duration.toFixed(2)}ms\n\n`;
                result += `æ‰€æœ‰æ€§èƒ½è®°å½•:\n`;
                entries.forEach(entry => {
                    result += `  ${entry.name}: ${entry.timestamp}ms\n`;
                });

                showResult('perf-result', result);
            } catch (error) {
                showResult('perf-result', `âŒ é”™è¯¯: ${error.message}`, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[Test] Agent & MCP Test Tool loaded');
            console.log('[Test] SquirrelBridge version:', window.SquirrelBridge);
        });
    </script>
</body>
</html>
